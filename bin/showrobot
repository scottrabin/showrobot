#!/usr/bin/env ruby

# ensure ShowRobot's lib directory is in Ruby's load path
$LOAD_PATH.unshift(File.dirname(__FILE__) + '/../lib') unless $LOAD_PATH.include?(File.dirname(__FILE__) + '/../lib')

# dependencies
require 'trollop'
require 'showrobot'

# parse options
options = Trollop::options do
	opt :identify, "Identify a show from the filename", :default => false
	opt :duration, "Determine the length of a video file", :default => false
	opt :episode, "Determine the season and episode of a file from the filename", :default => false
	opt :database, "Use the specified database for the search", :default => 'tvrage', :short => :d
	opt :fetch, "Fetch matches from the specified database", :default => false
	opt :verbose, "Show detailed information messages", :default => false

	# prompts user to choose amongst various options instead of deferring to the first
	opt :prompt, "Prompt for media file matches", :default => false, :short => :p
end
files = ARGV # Trollop modifies this, all that's left is the list of files

ShowRobot.verbose = options[:verbose]
files.select { |file| ShowRobot::MediaFile.isvideo? file }.each do |file|
	puts "Processing file #{file}" if ShowRobot.verbose
	media = ShowRobot::MediaFile.load file

	if media.is_movie?

	else
		seriesName = if options[:prompt]
						 # get the user's choice
					 else
						 media.series(options[:database]).first
					 end

		puts "Identified as series [ #{seriesName[0]} ]"
	end


	data = Array.new

	data << media.name_guess if options[:identify]
	data << media.duration   if options[:duration]
	data << media.season << media.episode if options[:episode]

	print data.join "\t"
end
